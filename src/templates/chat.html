{% extends "base.html" %}

{% block title %}IAToolkit{% endblock %}

{% block content %}
<!-- Sección de encabezado con el usuario conectado -->
<div class="company-section">
    <span class="text-muted small fw-bold ms-auto">
        {{ company_short_name }} - {{ external_user_id or user.email }}
    </span>

    <!-- Icono de cerrar sesión -->
    {% if user.email %}
        <a href="{{ url_for('logout', company_short_name=company_short_name) }}"
     |         class="fs-4 ms-3" title="Cerrar sesión">
            <i class="bi bi-box-arrow-right"></i>
        </a>
    {% endif %}
</div>

<div id="chat-container"
     class="mt-2 p-3 border border-2 rounded"
    style="height: 67vh;">
        <div id="chat-messages">
        <!-- Mensaje de bienvenida estático -->
        <div class="answer-section">
            ¡Hello! I'm an <strong> IAToolkit </strong> powered chatbot.
        </div>

    </div>

</div>

<!-- Input oculto de FilePond -->
<div class="filepond-container" style="display: none;">
    <input type="file" id="file-upload" class="filepond" data-max-files="5" multiple>
</div>

<!-- Contenedor principal que alinea el área de inputs -->
<!-- Se usa 'align-items-end' para que los botones se alineen con la base del textarea. -->
<div class="input-row d-flex align-items-end mt-2 mb-2 position-relative">

    <!-- Contenedor para los inputs que crecerá para llenar el espacio -->
    <div class="input-container">
        <!-- PRIMERA FILA: Input de cliente y selector de preguntas -->
        <div class="row g-2 mb-2 first-line-input-container">
            <div class="col-md">
                <!-- Contenedor con posicionamiento relativo para el input y el botón -->
                <div class="position-relative">
                    <div class="form-floating">
                        <input type="text" id="client-input"
                               class="form-control form-control-soft"
                               placeholder="Identifica al cliente con su RUT  ...">
                        <label for="client-input">
                            Identifica un cliente con su RUT o parte del nombre ...
                        </label>
                    </div>
                    <!-- Botón para limpiar, ahora dentro del contenedor relativo -->
                    <button type="button" id="clear-client-input-button" class="btn"
                            style="display: none; border: none;">
                        <i class="bi bi-x-circle-fill"></i>
                    </button>
                </div>
            </div>

                <div class="col-md">
                <div class="position-relative">
                    <!-- Grupo de botones con la clase .dropup para que se abra hacia arriba -->
                    <div class="btn-group dropup w-100">
                        <!-- El botón que el usuario verá y que mostrará la opción seleccionada -->
                        <button type="button" id="agent-select-button"
                                class="btn btn-light border dropdown-toggle w-100 text-start" data-bs-toggle="dropdown"
                                aria-expanded="false">
                            List of available prompts ....
                        </button>

                        <!-- El menú desplegable que contiene las opciones -->
                        <ul class="dropdown-menu dropdown-menu-soft w-100">
                            {% if prompts and prompts.message %}
                            {% for category_group in prompts.message %}

                            <!-- Título de la categoría -->
                            <li><h6 class="dropdown-header">{{ category_group.category_name }}</h6></li>

                            <!-- Opciones de la categoría -->
                            {% for prompt in category_group.prompts %}
                            <li>
                                <a class="dropdown-item" href="#" data-value="{{ prompt.prompt }}">
                                    {{ prompt.description }}
                                </a>
                            </li>
                            {% endfor %}

                            <!-- Divisor entre categorías si no es la última -->
                            {% if not loop.last %}
                            <li>
                                <hr class="dropdown-divider">
                            </li>
                            {% endif %}
                            {% endfor %}
                            {% endif %}
                        </ul>
                    </div>

                    <!-- Input oculto para guardar el valor seleccionado y enviarlo con el formulario -->
                    <button type="button" id="clear-selection-button" class="btn" style="display: none; border: none;">
                        <i class="bi bi-x-circle-fill"></i>
                    </button>

                </div>
                <!-- Inputs ocultos (sin cambios) -->
                <input type="hidden" id="agent-select-value" name="agent_select_value">
                <input type="hidden" id="agent-select-description" name="agent-select-description">

            </div>
        </div>

        <!-- SEGUNDA FILA: Textarea principal -->
        <div class="row second-line-input-container">
            <div class="col-md">
                <div class="input-group">
                    <textarea id="question" placeholder="Escribe tu consulta aquí..."
                          class="form-control form-control-soft"
                          style="resize: none;" rows="2" required></textarea>
                </div>
            </div>

        </div>
    </div>

    <div class="flex-shrink-0 d-flex flex-column align-items-center ms-2">
        <!-- Fila 1: Contenedores para botones de Enviar y Detener -->
        <div id="send-button-container" class="mb-1">
            <button id="send-button" class="btn btn-primary px-4 rounded">
                Enviar
            </button>
        </div>
        <div id="stop-button-container" class="mb-1" style="display: none;">
            <button id="stop-button" class="btn btn-danger px-4 rounded">
                <i class="bi bi-stop-circle" style="margin-right: 5px;"></i> Detener
            </button>
        </div>

        <!-- Fila 2: Iconos (alineados horizontalmente y centrados) -->
        <div class="d-flex justify-content-center">
            <!-- Icono de adjuntar -->
            <div id="paperclip-button-container" class="me-2"> <!-- me-2 para margen a la derecha -->
                <a href="javascript:void(0);" id="paperclip-button" title="Adjuntar archivos">
                    <i class="bi bi-paperclip" style="font-size: 1rem; color: #6c757d;"></i>
                </a>
            </div>

            <!-- Icono de ver archivos (oculto inicialmente) -->
            <div id="view-files-button-container" style="display: none;">
                <a href="javascript:void(0);" id="view-files-button" title="Ver archivos adjuntos">
                    <i class="bi bi-file-earmark-text" style="font-size: 1rem; color: #007bff;"></i>
                </a>
            </div>
            <div class="buttons-container">
                <i id="history-button"
                   class="bi bi-clock-history text-success"
                   style="font-size: 1.5em; cursor: pointer;"
                   title="Historial con mis consultas">
                </i>
                <i id="send-feedback-button"
                   class="bi bi-emoji-smile"
                   style="font-size: 1.5em; cursor: pointer; color: #532323;"
                   title="Tu feedback es muy importante">
                </i>
            </div>
        </div>
    </div>
</div>

<!-- ****   FIN de la copia de HTML  -->

<!-- Incluir los modales desde un archivo externo -->
{% include 'chat_modals.html' %}

{% endblock %}

{% block scripts %}
{% if auth_method == 'jwt' and session_jwt %}
<script>
    // Guardar el JWT de sesión
    const sessionJWT = "{{ session_jwt }}";
    const companyShortName = "{{ company_short_name }}"; // Para la URL del query enviada en JS
    const externalUserId = "{{ external_user_id }}";
</script>
{% endif %}

<script>
    window.companyShortName = "{{ company_short_name }}";
    window.iatoolkit_base_url = "{{ iatoolkit_base_url }}";
    window.externalUserId = "{{ external_user_id }}";
</script>
{% endblock %}