{% extends "base.html" %}

{% block title %}IAToolkit{% endblock %}

{% block content %}
<!-- Sección de encabezado con el usuario conectado -->
<div class="company-section">
    <span class="text-muted small fw-bold ms-auto">
        {{ company_short_name }} - {{ external_user_id or user.email }}
    </span>

    <!-- Icono de cerrar sesión -->
    {% if user.email %}
        <a href="{{ url_for('logout', company_short_name=company_short_name) }}"
             class="fs-4 ms-3" title="Cerrar sesión">
            <i class="bi bi-box-arrow-right"></i>
        </a>
    {% endif %}
</div>

<div id="chat-container"
     class="mt-2 p-3 border border-2 rounded"
    style="height: 67vh;">
        <div id="chat-messages">
        <!-- Mensaje de bienvenida estático -->
        <div class="answer-section">
            ¡Hello! I'm an <strong> IAToolkit </strong> powered chatbot.
        </div>

    </div>

</div>

<!-- Input oculto de FilePond -->
<div class="filepond-container" style="display: none;">
    <input type="file" id="file-upload" class="filepond" data-max-files="5" multiple>
</div>

<div class="input-row d-flex align-items-end mt-2 mb-2">

    <!-- COLUMNA IZQUIERDA: Contiene todos los inputs y crece para ocupar el espacio disponible -->
    <div class="flex-grow-1">
        <!-- Fila superior: Prompts y (opcional) datos de empresa -->
        <div class="row g-2 mb-2">
            {% set prompt_col_class = 'col-md-4' %}
            <div class="{{ prompt_col_class }}">
                <div class="position-relative h-100">
                    <!-- selector de prompts -->
                    <div class="input-group dropup h-100">
                        <button type="button"
                                id="prompt-select-button"
                                class="btn btn-light border dropdown-toggle w-100 text-start"
                                data-bs-toggle="dropdown" aria-expanded="false">
                            Prompts disponibles ....
                        </button>
                        <ul class="dropdown-menu dropdown-menu-soft w-100">
                            {% if prompts and prompts.message %}
                            {% for category_group in prompts.message %}
                                <li><h6 class="dropdown-header">{{ category_group.category_name }}</h6></li>
                                {% for prompt in category_group.prompts %}
                                    <li><a class="dropdown-item" href="#" data-value="{{ prompt.prompt }}">{{ prompt.description }}</a></li>
                                {% endfor %}
                                {% if not loop.last %}
                                    <li><hr class="dropdown-divider"></li>
                                {% endif %}
                            {% endfor %}
                            {% endif %}
                        </ul>
                    </div>

                    <!-- Botón de limpiar para el selector de prompts -->
                    <button type="button" id="clear-selection-button"
                            class="btn clear-specific-data-button"
                            style="display: none;">
                        <i class="bi bi-x-circle-fill"></i>
                    </button>
                </div>
                <input type="hidden" id="prompt-select-value" name="prompt_select_value">
                <input type="hidden" id="prompt-select-description" name="prompt-select-description">
            </div>

            {% if company_ui_config and company_ui_config.enabled %}
            <div class="col-md">
                <!-- optional: company specific data -->
                <div class="position-relative">
                    <div class="form-floating">
                        <input type="text" id="{{ company_ui_config.id }}" class="form-control form-control-soft specific-data-input" placeholder="{{ company_ui_config.placeholder }}">
                        <label for="{{ company_ui_config.id }}">{{ company_ui_config.label }}</label>
                    </div>
                    <button type="button" id="clear-{{ company_ui_config.id }}-button" class="btn clear-specific-data-button" style="display: none;"><i class="bi bi-x-circle-fill"></i></button>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Fila inferior: Textarea principal -->
        <div class="row g-2">
            <div class="col">
                <div class="input-group">
                    <textarea id="question" placeholder="Escribe tu consulta aquí..." class="form-control form-control-soft" style="resize: none;" rows="2" required></textarea>
                </div>
            </div>
        </div>
    </div>

    <!-- COLUMNA DERECHA: Contiene los botones y tiene un ancho fijo basado en su contenido -->
    <div class="flex-shrink-0 ms-2">
        <div class="d-flex flex-column align-items-center">
            <!-- Fila 1: Botones Enviar/Detener -->
            <div id="send-button-container" class="mb-1">
                <button id="send-button" class="btn btn-primary px-4 rounded">Enviar</button>
            </div>
            <div id="stop-button-container" class="mb-1" style="display: none;">
                <button id="stop-button" class="btn btn-danger px-4 rounded"><i class="bi bi-stop-circle" style="margin-right: 5px;"></i> Detener</button>
            </div>
            <!-- Fila 2: Iconos -->
            <div class="d-flex justify-content-center">
                <div id="paperclip-button-container" class="me-2">
                    <a href="javascript:void(0);" id="paperclip-button" title="Adjuntar archivos"><i class="bi bi-paperclip" style="font-size: 1rem; color: #6c757d;"></i></a>
                </div>
                <div id="view-files-button-container" style="display: none;">
                    <a href="javascript:void(0);" id="view-files-button" title="Ver archivos adjuntos"><i class="bi bi-file-earmark-text" style="font-size: 1rem; color: #007bff;"></i></a>
                </div>
                <div class="buttons-container">
                    <i id="history-button" class="bi bi-clock-history text-success" style="font-size: 1.5em; cursor: pointer;" title="Historial con mis consultas"></i>
                    <i id="send-feedback-button" class="bi bi-emoji-smile" style="font-size: 1.5em; cursor: pointer; color: #532323;" title="Tu feedback es muy importante"></i>
                </div>
            </div>
        </div>
    </div>
</div>


<!-- Incluir los modales desde un archivo externo -->
{% include 'chat_modals.html' %}

{% endblock %}

{% block scripts %}
{% if auth_method == 'jwt' and session_jwt %}
<script>
    // Guardar el JWT de sesión
    const sessionJWT = "{{ session_jwt }}";
    const companyShortName = "{{ company_short_name }}"; // Para la URL del query enviada en JS
    const externalUserId = "{{ external_user_id }}";
</script>
{% endif %}

<script>
    window.companyShortName = "{{ company_short_name }}";
    window.iatoolkit_base_url = "{{ iatoolkit_base_url }}";
    window.externalUserId = "{{ external_user_id }}";
    window.company_ui_config = {{ company_ui_config | tojson }};

</script>
{% endblock %}